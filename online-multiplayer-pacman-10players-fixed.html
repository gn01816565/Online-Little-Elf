<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šå¤šäººå°ç²¾éˆéŠæˆ² (10äººç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1200px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .menu-screen, .game-screen {
            display: none;
        }
        
        .menu-screen.active, .game-screen.active {
            display: block;
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid #667eea;
            border-radius: 10px;
            outline: none;
        }
        
        .input-group input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        .room-code {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
        
        .room-code h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .room-code .code {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            letter-spacing: 5px;
            font-family: monospace;
        }
        
        .players-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .players-list h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .player-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .player-info {
            padding: 10px 15px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
        }
        
        canvas {
            display: block;
            background: #000;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
            max-width: 100%;
        }
        
        .game-controls {
            margin-top: 20px;
            text-align: center;
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-message.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .back-button {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® ç·šä¸Šå¤šäººå°ç²¾éˆ (æœ€å¤š10äºº) ğŸ®</h1>
        
        <!-- ä¸»é¸å–® -->
        <div id="menuScreen" class="menu-screen active">
            <div class="menu-buttons">
                <button id="btnShowCreate">ğŸ¯ å»ºç«‹éŠæˆ²æˆ¿é–“</button>
                <button id="btnShowJoin">ğŸšª åŠ å…¥éŠæˆ²æˆ¿é–“</button>
            </div>
            
            <div id="createRoomSection" style="display: none;">
                <div class="input-group">
                    <label>ä½ çš„æš±ç¨±ï¼š</label>
                    <input type="text" id="hostName" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" maxlength="15">
                </div>
                <button id="btnCreateRoom">å»ºç«‹æˆ¿é–“</button>
                <button class="back-button" id="btnBackFromCreate">è¿”å›</button>
            </div>
            
            <div id="joinRoomSection" style="display: none;">
                <div class="input-group">
                    <label>ä½ çš„æš±ç¨±ï¼š</label>
                    <input type="text" id="playerName" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" maxlength="15">
                </div>
                <div class="input-group">
                    <label>æˆ¿é–“ä»£ç¢¼ï¼š</label>
                    <input type="text" id="roomCode" placeholder="è¼¸å…¥6ä½æ•¸æˆ¿é–“ä»£ç¢¼" maxlength="6">
                </div>
                <button id="btnJoinRoom">åŠ å…¥æˆ¿é–“</button>
                <button class="back-button" id="btnBackFromJoin">è¿”å›</button>
            </div>
        </div>
        
        <!-- ç­‰å¾…å®¤ -->
        <div id="lobbyScreen" class="menu-screen">
            <div class="room-code">
                <h3>æˆ¿é–“ä»£ç¢¼</h3>
                <div class="code" id="displayRoomCode"></div>
                <p style="margin-top: 10px; color: #666;">åˆ†äº«æ­¤ä»£ç¢¼çµ¦æœ‹å‹åŠ å…¥éŠæˆ²</p>
            </div>
            
            <div class="players-list">
                <h3>å·²åŠ å…¥ç©å®¶ (<span id="playerCount">0</span>/10)</h3>
                <div id="playersList"></div>
            </div>
            
            <div class="status-message info">
                ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥... (è‡³å°‘éœ€è¦2ä½ç©å®¶)
            </div>
            
            <button id="startButton" disabled>é–‹å§‹éŠæˆ²</button>
            <button class="back-button" id="btnLeaveLobby">é›¢é–‹æˆ¿é–“</button>
        </div>
        
        <!-- éŠæˆ²ç•«é¢ -->
        <div id="gameScreen" class="game-screen">
            <div class="info-panel" id="gameInfoPanel"></div>
            
            <canvas id="gameCanvas" width="1000" height="800"></canvas>
            
            <div class="game-controls">
                <p style="margin-bottom: 10px; color: #666;">
                    ä½¿ç”¨æ–¹å‘éµ â†‘ â†“ â† â†’ æˆ– W A S D ç§»å‹•
                </p>
                <button class="back-button" id="btnLeaveGame">é›¢é–‹éŠæˆ²</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        // Firebase é…ç½® - è«‹æ›¿æ›ç‚ºä½ è‡ªå·±çš„é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBexampleKey123456789",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // åˆå§‹åŒ– Firebase
        let database;
        let isDemo = false;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.log('Firebase é…ç½®éŒ¯èª¤ - ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼', error);
            isDemo = true;
            // ä¸é¡¯ç¤º alertï¼Œè®“æ¸¬è©¦ç¹¼çºŒ
        }

        // 10ç¨®ä¸åŒé¡è‰²
        const playerColors = [
            '#FFD700',  // é‡‘é»ƒè‰²
            '#FF69B4',  // ç²‰ç´…è‰²
            '#00CED1',  // é’è—è‰²
            '#32CD32',  // ç¶ è‰²
            '#FF6347',  // ç•ªèŒ„ç´…
            '#9370DB',  // ç´«è‰²
            '#FFA500',  // æ©™è‰²
            '#00FA9A',  // ä¸­ç¶ è‰²
            '#FF1493',  // æ·±ç²‰è‰²
            '#4169E1'   // çš‡å®¶è—
        ];
        
        // éŠæˆ²ç‹€æ…‹
        let currentRoomId = null;
        let currentPlayerId = null;
        let isHost = false;
        let gameState = null;
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const CELL_SIZE = 20;
        const COLS = canvas.width / CELL_SIZE;
        const ROWS = canvas.height / CELL_SIZE;
        
        // 10å€‹ä¸åŒçš„èµ·å§‹ä½ç½®
        const startPositions = [
            { x: 2, y: 2 },
            { x: COLS - 3, y: 2 },
            { x: 2, y: ROWS - 3 },
            { x: COLS - 3, y: ROWS - 3 },
            { x: Math.floor(COLS / 2), y: 2 },
            { x: Math.floor(COLS / 2), y: ROWS - 3 },
            { x: 2, y: Math.floor(ROWS / 2) },
            { x: COLS - 3, y: Math.floor(ROWS / 2) },
            { x: Math.floor(COLS / 4), y: Math.floor(ROWS / 4) },
            { x: Math.floor(COLS * 3 / 4), y: Math.floor(ROWS * 3 / 4) }
        ];
        
        // ç”Ÿæˆæˆ¿é–“ä»£ç¢¼
        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // é¡¯ç¤ºå»ºç«‹æˆ¿é–“ç•Œé¢
        function showCreateRoom() {
            console.log('showCreateRoom called');
            document.querySelectorAll('.menu-buttons > button').forEach(b => b.style.display = 'none');
            document.getElementById('createRoomSection').style.display = 'block';
        }
        
        // é¡¯ç¤ºåŠ å…¥æˆ¿é–“ç•Œé¢
        function showJoinRoom() {
            console.log('showJoinRoom called');
            document.querySelectorAll('.menu-buttons > button').forEach(b => b.style.display = 'none');
            document.getElementById('joinRoomSection').style.display = 'block';
        }
        
        // è¿”å›ä¸»é¸å–®
        function backToMenu() {
            document.getElementById('createRoomSection').style.display = 'none';
            document.getElementById('joinRoomSection').style.display = 'none';
            document.querySelectorAll('.menu-buttons > button').forEach(b => b.style.display = 'block');
        }
        
        // å»ºç«‹æˆ¿é–“
        async function createRoom() {
            console.log('createRoom function called');
            const hostName = document.getElementById('hostName').value.trim();
            console.log('Host name:', hostName);
            
            if (!hostName) {
                alert('è«‹è¼¸å…¥ä½ çš„æš±ç¨±');
                return;
            }
            
            console.log('Database status:', database ? 'Available' : 'Not available');
            
            if (!database) {
                alert('Firebase æœªæ­£ç¢ºé…ç½®ï¼Œç„¡æ³•å»ºç«‹æˆ¿é–“');
                return;
            }
            
            console.log('Creating room...');
            
            const roomCode = generateRoomCode();
            currentRoomId = roomCode;
            currentPlayerId = 'player_' + Date.now();
            isHost = true;
            
            // æ¼”ç¤ºæ¨¡å¼ - ç›´æ¥åˆ‡æ›åˆ°ç­‰å¾…å®¤
            if (isDemo) {
                console.log('Demo mode - switching to lobby');
                alert('âš ï¸ æ¼”ç¤ºæ¨¡å¼\n\nFirebase æœªé…ç½®ï¼Œç„¡æ³•çœŸæ­£å»ºç«‹ç·šä¸Šæˆ¿é–“ã€‚\né€™åªæ˜¯ç•Œé¢æ¼”ç¤ºã€‚\n\nè¦å•Ÿç”¨çœŸæ­£çš„å¤šäººé€£ç·šï¼Œè«‹ä¾ç…§ README é…ç½® Firebaseã€‚');
                document.getElementById('menuScreen').classList.remove('active');
                document.getElementById('lobbyScreen').classList.add('active');
                document.getElementById('displayRoomCode').textContent = roomCode;
                document.getElementById('playerCount').textContent = '1';
                document.getElementById('playersList').innerHTML = `
                    <div class="player-item" style="background: ${playerColors[0]}20; border: 2px solid ${playerColors[0]}">
                        <div class="player-color-dot" style="background: ${playerColors[0]}"></div>
                        <span style="color: #333">${hostName} (ä½ )</span>
                    </div>
                `;
                return;
            }
            
            const roomRef = database.ref(`rooms/${roomCode}`);
            const playerRef = database.ref(`rooms/${roomCode}/players/${currentPlayerId}`);
            
            // å»ºç«‹æˆ¿é–“è³‡æ–™
            await roomRef.set({
                code: roomCode,
                status: 'waiting',
                createdAt: Date.now(),
                host: currentPlayerId,
                maxPlayers: 10
            });
            
            // åŠ å…¥ç©å®¶
            const pos = startPositions[0];
            await playerRef.set({
                name: hostName,
                color: playerColors[0],
                score: 0,
                x: pos.x,
                y: pos.y,
                joinedAt: Date.now()
            });
            
            // è¨­å®šæ–·ç·šè™•ç†
            playerRef.onDisconnect().remove();
            
            // ç›£è½æˆ¿é–“è®ŠåŒ–
            listenToRoom();
            
            // åˆ‡æ›åˆ°ç­‰å¾…å®¤
            document.getElementById('menuScreen').classList.remove('active');
            document.getElementById('lobbyScreen').classList.add('active');
            document.getElementById('displayRoomCode').textContent = roomCode;
        }
        
        // åŠ å…¥æˆ¿é–“
        async function joinRoom() {
            console.log('joinRoom function called');
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            
            console.log('Player name:', playerName);
            console.log('Room code:', roomCode);
            
            if (!playerName) {
                alert('è«‹è¼¸å…¥ä½ çš„æš±ç¨±');
                return;
            }
            
            if (!roomCode || roomCode.length !== 6) {
                alert('è«‹è¼¸å…¥æ­£ç¢ºçš„6ä½æ•¸æˆ¿é–“ä»£ç¢¼');
                return;
            }
            
            if (isDemo) {
                alert('âš ï¸ æ¼”ç¤ºæ¨¡å¼\n\nFirebase æœªé…ç½®ï¼Œç„¡æ³•åŠ å…¥ç·šä¸Šæˆ¿é–“ã€‚\n\nè¦å•Ÿç”¨çœŸæ­£çš„å¤šäººé€£ç·šï¼Œè«‹ä¾ç…§ README é…ç½® Firebaseã€‚');
                return;
            }
            
            console.log('Database status:', database ? 'Available' : 'Not available');
            
            if (!database) {
                alert('Firebase æœªæ­£ç¢ºé…ç½®ï¼Œç„¡æ³•åŠ å…¥æˆ¿é–“');
                return;
            }
            
            // æª¢æŸ¥æˆ¿é–“æ˜¯å¦å­˜åœ¨
            const roomRef = database.ref(`rooms/${roomCode}`);
            const snapshot = await roomRef.once('value');
            
            if (!snapshot.exists()) {
                alert('æˆ¿é–“ä¸å­˜åœ¨ï¼Œè«‹æª¢æŸ¥æˆ¿é–“ä»£ç¢¼');
                return;
            }
            
            const roomData = snapshot.val();
            const playerCount = roomData.players ? Object.keys(roomData.players).length : 0;
            
            if (playerCount >= 10) {
                alert('æˆ¿é–“å·²æ»¿ (æœ€å¤š10ä½ç©å®¶)');
                return;
            }
            
            if (roomData.status === 'playing') {
                alert('éŠæˆ²å·²ç¶“é–‹å§‹ï¼Œç„¡æ³•åŠ å…¥');
                return;
            }
            
            currentRoomId = roomCode;
            currentPlayerId = 'player_' + Date.now();
            
            const playerRef = database.ref(`rooms/${roomCode}/players/${currentPlayerId}`);
            
            // åŠ å…¥ç©å®¶
            const pos = startPositions[playerCount];
            await playerRef.set({
                name: playerName,
                color: playerColors[playerCount],
                score: 0,
                x: pos.x,
                y: pos.y,
                joinedAt: Date.now()
            });
            
            // è¨­å®šæ–·ç·šè™•ç†
            playerRef.onDisconnect().remove();
            
            // ç›£è½æˆ¿é–“è®ŠåŒ–
            listenToRoom();
            
            // åˆ‡æ›åˆ°ç­‰å¾…å®¤
            document.getElementById('menuScreen').classList.remove('active');
            document.getElementById('lobbyScreen').classList.add('active');
            document.getElementById('displayRoomCode').textContent = roomCode;
        }
        
        // ç›£è½æˆ¿é–“è®ŠåŒ–
        function listenToRoom() {
            const roomRef = database.ref(`rooms/${currentRoomId}`);
            
            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                
                if (!data) {
                    alert('æˆ¿é–“å·²é—œé–‰');
                    window.location.reload();
                    return;
                }
                
                // æ›´æ–°ç©å®¶åˆ—è¡¨
                updatePlayersList(data.players || {});
                
                // æª¢æŸ¥æ˜¯å¦å¯ä»¥é–‹å§‹éŠæˆ²
                const playerCount = Object.keys(data.players || {}).length;
                const startButton = document.getElementById('startButton');
                if (isHost && playerCount >= 2) {
                    startButton.disabled = false;
                }
                
                // å¦‚æœéŠæˆ²é–‹å§‹ï¼Œåˆ‡æ›åˆ°éŠæˆ²ç•«é¢
                if (data.status === 'playing' && !gameState) {
                    initGame(data);
                } else if (data.status === 'playing' && gameState) {
                    updateGameState(data);
                }
            });
        }
        
        // æ›´æ–°ç©å®¶åˆ—è¡¨
        function updatePlayersList(players) {
            const playersList = document.getElementById('playersList');
            const playerCount = document.getElementById('playerCount');
            
            playerCount.textContent = Object.keys(players).length;
            playersList.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.style.background = player.color + '20';
                div.style.border = `2px solid ${player.color}`;
                
                const dot = document.createElement('div');
                dot.className = 'player-color-dot';
                dot.style.background = player.color;
                
                const name = document.createElement('span');
                name.textContent = `${player.name} ${id === currentPlayerId ? '(ä½ )' : ''}`;
                name.style.color = '#333';
                
                div.appendChild(dot);
                div.appendChild(name);
                playersList.appendChild(div);
            });
        }
        
        // é–‹å§‹éŠæˆ²
        async function startGame() {
            if (!isHost) return;
            
            const roomRef = database.ref(`rooms/${currentRoomId}`);
            const snapshot = await roomRef.once('value');
            const roomData = snapshot.val();
            
            // ç”Ÿæˆè¿·å®®
            const maze = generateMaze();
            
            // æ›´æ–°æˆ¿é–“ç‹€æ…‹
            await roomRef.update({
                status: 'playing',
                maze: maze,
                startedAt: Date.now()
            });
        }
        
        // ç”Ÿæˆè¿·å®®
        function generateMaze() {
            const maze = [];
            for (let y = 0; y < ROWS; y++) {
                maze[y] = [];
                for (let x = 0; x < COLS; x++) {
                    if (x === 0 || x === COLS - 1 || y === 0 || y === ROWS - 1) {
                        maze[y][x] = 1;
                    } else if (Math.random() < 0.12 && (x % 3 === 0 && y % 3 === 0)) {
                        maze[y][x] = 1;
                    } else if (Math.random() < 0.04) {
                        maze[y][x] = 3;
                    } else if (Math.random() < 0.65) {
                        maze[y][x] = 2;
                    } else {
                        maze[y][x] = 0;
                    }
                }
            }
            
            // ç¢ºä¿èµ·å§‹ä½ç½®å‘¨åœæ²’æœ‰ç‰†
            startPositions.forEach(pos => {
                for (let dy = -2; dy <= 2; dy++) {
                    for (let dx = -2; dx <= 2; dx++) {
                        const ny = pos.y + dy;
                        const nx = pos.x + dx;
                        if (ny >= 0 && ny < ROWS && nx >= 0 && nx < COLS) {
                            if (maze[ny][nx] === 1) maze[ny][nx] = 0;
                        }
                    }
                }
            });
            
            return maze;
        }
        
        // åˆå§‹åŒ–éŠæˆ²
        function initGame(data) {
            gameState = data;
            
            document.getElementById('lobbyScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            
            // æ›´æ–°ç©å®¶è³‡è¨Šé¢æ¿
            updateInfoPanel(data.players);
            
            // é–‹å§‹éŠæˆ²å¾ªç’°
            gameLoop();
            
            // ç›£è½éµç›¤
            setupKeyboardControls();
        }
        
        // æ›´æ–°ç©å®¶è³‡è¨Šé¢æ¿
        function updateInfoPanel(players) {
            const panel = document.getElementById('gameInfoPanel');
            panel.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const div = document.createElement('div');
                div.className = 'player-info';
                div.style.background = `linear-gradient(135deg, ${player.color} 0%, ${player.color}CC 100%)`;
                div.innerHTML = `
                    <div style="font-size: 0.85em;">${player.name}${id === currentPlayerId ? ' (ä½ )' : ''}</div>
                    <div>åˆ†æ•¸: <span id="score-${id}">${player.score || 0}</span></div>
                `;
                panel.appendChild(div);
            });
        }
        
        // è¨­å®šéµç›¤æ§åˆ¶
        function setupKeyboardControls() {
            let lastMoveTime = 0;
            const moveDelay = 120;
            
            document.addEventListener('keydown', async (e) => {
                if (!gameState || Date.now() - lastMoveTime < moveDelay) return;
                
                const playerRef = database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`);
                const snapshot = await playerRef.once('value');
                const player = snapshot.val();
                
                if (!player) return;
                
                let newX = player.x;
                let newY = player.y;
                
                if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                    newY--;
                } else if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                    newY++;
                } else if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                    newX--;
                } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                    newX++;
                } else {
                    return;
                }
                
                e.preventDefault();
                
                // æª¢æŸ¥ç¢°æ’
                if (newX >= 0 && newX < COLS && newY >= 0 && newY < ROWS) {
                    if (gameState.maze[newY][newX] !== 1) {
                        lastMoveTime = Date.now();
                        
                        const updates = {
                            x: newX,
                            y: newY
                        };
                        
                        // æª¢æŸ¥æ˜¯å¦åƒåˆ°è±†å­
                        if (gameState.maze[newY][newX] === 2) {
                            updates.score = (player.score || 0) + 10;
                            await database.ref(`rooms/${currentRoomId}/maze/${newY}/${newX}`).set(0);
                        } else if (gameState.maze[newY][newX] === 3) {
                            // åƒåˆ°èƒ½é‡è±†ï¼šåŠ åˆ† + é€²å…¥ power mode
                            updates.score = (player.score || 0) + 50;
                            updates.powerMode = true;
                            updates.powerEndTime = Date.now() + 15000; // 15ç§’ power mode
                            await database.ref(`rooms/${currentRoomId}/maze/${newY}/${newX}`).set(0);
                        }
                        
                        await playerRef.update(updates);

                        // æª¢æŸ¥ç¢°æ’ï¼ˆç§»å‹•å¾Œï¼‰
                        checkCollision(newX, newY);
                    }
                }
            });
        }

        // æª¢æŸ¥ç©å®¶ç¢°æ’ä¸¦åŸ·è¡Œæ¶åˆ†
        async function checkCollision(myX, myY) {
            if (!gameState || !gameState.players || !currentPlayerId) return;

            const myPlayer = gameState.players[currentPlayerId];
            if (!myPlayer) return;

            const now = Date.now();
            const myPowerMode = myPlayer.powerMode && myPlayer.powerEndTime && now < myPlayer.powerEndTime;

            // éæ­·æ‰€æœ‰å…¶ä»–ç©å®¶
            for (const [otherId, otherPlayer] of Object.entries(gameState.players)) {
                if (otherId === currentPlayerId) continue; // è·³éè‡ªå·±

                // æª¢æŸ¥ä½ç½®æ˜¯å¦é‡ç–Šï¼ˆåŒä¸€æ ¼æˆ–ç›¸é„°ï¼‰
                const distance = Math.abs(myX - otherPlayer.x) + Math.abs(myY - otherPlayer.y);
                if (distance <= 1) { // ç¢°æ’ï¼
                    const otherPowerMode = otherPlayer.powerMode && otherPlayer.powerEndTime && now < otherPlayer.powerEndTime;

                    let myScoreChange = 0;
                    let otherScoreChange = 0;

                    // åˆ¤æ–·æ¶åˆ†è¦å‰‡
                    if (myPowerMode && !otherPowerMode) {
                        // æˆ‘åœ¨ power modeï¼Œå°æ–¹ä¸åœ¨ï¼šæ¶ 50%
                        const stolen = Math.floor((otherPlayer.score || 0) * 0.5);
                        myScoreChange = stolen;
                        otherScoreChange = -stolen;
                        showScoreFloating(myX, myY, `+${stolen}`, '#00FF00');
                        showScoreFloating(otherPlayer.x, otherPlayer.y, `-${stolen}`, '#FF0000');
                    } else if (!myPowerMode && otherPowerMode) {
                        // å°æ–¹åœ¨ power modeï¼Œæˆ‘ä¸åœ¨ï¼šè¢«æ¶ 50%
                        const stolen = Math.floor((myPlayer.score || 0) * 0.5);
                        myScoreChange = -stolen;
                        otherScoreChange = stolen;
                        showScoreFloating(myX, myY, `-${stolen}`, '#FF0000');
                    } else if (myPowerMode && otherPowerMode) {
                        // é›™æ–¹éƒ½åœ¨ power modeï¼šå½ˆé–‹ï¼Œä¸æ¶åˆ†
                        console.log('Both in power mode - bounce!');
                        return;
                    } else {
                        // é›™æ–¹éƒ½ä¸åœ¨ power modeï¼šåˆ†æ•¸é«˜è€…æ¶ 20%
                        const myScore = myPlayer.score || 0;
                        const otherScore = otherPlayer.score || 0;

                        if (myScore > otherScore) {
                            const stolen = Math.floor(otherScore * 0.2);
                            myScoreChange = stolen;
                            otherScoreChange = -stolen;
                            showScoreFloating(myX, myY, `+${stolen}`, '#00FF00');
                            showScoreFloating(otherPlayer.x, otherPlayer.y, `-${stolen}`, '#FF0000');
                        } else if (otherScore > myScore) {
                            const stolen = Math.floor(myScore * 0.2);
                            myScoreChange = -stolen;
                            otherScoreChange = stolen;
                            showScoreFloating(myX, myY, `-${stolen}`, '#FF0000');
                        }
                        // åˆ†æ•¸ç›¸ç­‰å‰‡ä¸æ¶
                    }

                    // æ›´æ–°åˆ†æ•¸ï¼ˆç¢ºä¿ä¸æœƒè®Šæˆè² æ•¸ï¼‰
                    if (myScoreChange !== 0) {
                        const newScore = Math.max(0, (myPlayer.score || 0) + myScoreChange);
                        await database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}/score`).set(newScore);
                    }
                    if (otherScoreChange !== 0) {
                        const newOtherScore = Math.max(0, (otherPlayer.score || 0) + otherScoreChange);
                        await database.ref(`rooms/${currentRoomId}/players/${otherId}/score`).set(newOtherScore);
                    }

                    break; // åªè™•ç†ç¬¬ä¸€å€‹ç¢°æ’
                }
            }
        }

        // åˆ†æ•¸é£„å­—å‹•ç•«æ•¸æ“š
        let floatingTexts = [];

        // æ·»åŠ åˆ†æ•¸é£„å­—
        function showScoreFloating(x, y, text, color) {
            floatingTexts.push({
                x: x * CELL_SIZE + CELL_SIZE / 2,
                y: y * CELL_SIZE - 20,
                text: text,
                color: color,
                alpha: 1.0,
                createdAt: Date.now()
            });
        }

        // æ›´æ–°éŠæˆ²ç‹€æ…‹
        function updateGameState(data) {
            gameState = data;
            
            // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            if (data.players) {
                Object.entries(data.players).forEach(([id, player]) => {
                    const scoreEl = document.getElementById(`score-${id}`);
                    if (scoreEl) {
                        scoreEl.textContent = player.score || 0;
                    }
                });
            }
        }
        
        // éŠæˆ²å¾ªç’°
        function gameLoop() {
            if (!gameState) return;

            const now = Date.now();

            // è¨ˆç®—éŠæˆ²å‰©é¤˜æ™‚é–“ï¼ˆ3åˆ†é˜ = 180ç§’ï¼‰
            const GAME_DURATION = 180 * 1000; // 3åˆ†é˜ï¼ˆæ¯«ç§’ï¼‰
            const elapsed = now - (gameState.startedAt || now);
            const remaining = Math.max(0, GAME_DURATION - elapsed);
            const remainingSeconds = Math.ceil(remaining / 1000);
            const isLastThirty = remainingSeconds <= 30 && remainingSeconds > 0;

            // æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
            if (remaining === 0 && gameState.status === 'playing' && isHost && database) {
                // æ™‚é–“åˆ°ï¼çµæŸéŠæˆ²
                database.ref(`rooms/${currentRoomId}`).update({
                    status: 'finished',
                    finishedAt: now
                });
                showGameResults();
                return;
            }

            // æª¢æŸ¥ä¸¦æ¸…é™¤éæœŸçš„ power mode
            if (gameState.players && database) {
                Object.entries(gameState.players).forEach(([id, player]) => {
                    if (player.powerMode && player.powerEndTime && now >= player.powerEndTime) {
                        // power mode å·²éæœŸï¼Œæ¸…é™¤ç‹€æ…‹
                        database.ref(`rooms/${currentRoomId}/players/${id}`).update({
                            powerMode: false,
                            powerEndTime: null
                        });
                    }
                });
            }

            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // æœ€å¾Œ30ç§’èƒŒæ™¯é–ƒçˆè­¦å‘Š
            if (isLastThirty && Math.floor(now / 500) % 2 === 0) {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // ç¹ªè£½è¿·å®®
            if (gameState.maze) {
                for (let y = 0; y < ROWS; y++) {
                    for (let x = 0; x < COLS; x++) {
                        if (gameState.maze[y][x] === 1) {
                            ctx.fillStyle = '#0000FF';
                            ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                            ctx.strokeStyle = '#4169E1';
                            ctx.strokeRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                        } else if (gameState.maze[y][x] === 2) {
                            ctx.fillStyle = '#FFF';
                            ctx.beginPath();
                            ctx.arc(x * CELL_SIZE + CELL_SIZE / 2, y * CELL_SIZE + CELL_SIZE / 2, 3, 0, Math.PI * 2);
                            ctx.fill();
                        } else if (gameState.maze[y][x] === 3) {
                            ctx.fillStyle = '#FFD700';
                            ctx.beginPath();
                            ctx.arc(x * CELL_SIZE + CELL_SIZE / 2, y * CELL_SIZE + CELL_SIZE / 2, 6, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.strokeStyle = '#FFA500';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                }
            }
            
            // ç¹ªè£½ç©å®¶
            if (gameState.players) {
                const now = Date.now();
                Object.entries(gameState.players).forEach(([id, player]) => {
                    const centerX = player.x * CELL_SIZE + CELL_SIZE / 2;
                    const centerY = player.y * CELL_SIZE + CELL_SIZE / 2;

                    // æª¢æŸ¥æ˜¯å¦åœ¨ power mode
                    const isPowerMode = player.powerMode && player.powerEndTime && now < player.powerEndTime;
                    const timeRemaining = isPowerMode ? (player.powerEndTime - now) / 1000 : 0;
                    const isWarning = timeRemaining > 0 && timeRemaining <= 5; // æœ€å¾Œ5ç§’è­¦å‘Š
                    const shouldFlash = isWarning && Math.floor(now / 200) % 2 === 0; // 200msé–ƒçˆ

                    // Power mode è¦–è¦ºæ•ˆæœ
                    if (isPowerMode && !shouldFlash) {
                        const baseRadius = CELL_SIZE / 2 - 2;
                        const powerRadius = baseRadius * 1.2; // è®Šå¤§ 1.2 å€

                        // å½©è™¹å…‰æšˆæ•ˆæœï¼ˆå¤šå±¤æ¼¸è®Šåœ“ï¼‰
                        const hue = (now / 50) % 360; // å½©è™¹è‰²ç›¸æ—‹è½‰

                        // å¤–å±¤å…‰æšˆ
                        for (let i = 3; i >= 0; i--) {
                            const gradient = ctx.createRadialGradient(
                                centerX, centerY, powerRadius,
                                centerX, centerY, powerRadius + 6 + i * 2
                            );
                            gradient.addColorStop(0, `hsla(${(hue + i * 30) % 360}, 100%, 50%, 0.4)`);
                            gradient.addColorStop(1, `hsla(${(hue + i * 30) % 360}, 100%, 50%, 0)`);

                            ctx.fillStyle = gradient;
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, powerRadius + 8 + i * 2, 0, Math.PI * 2);
                            ctx.fill();
                        }

                        // ç©å®¶æœ¬é«”ï¼ˆæ›´å¤§ï¼‰
                        ctx.fillStyle = player.color;
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, powerRadius, 0, Math.PI * 2);
                        ctx.fill();

                        // çœ¼ç›ï¼ˆæ”¾å¤§ï¼‰
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.arc(centerX - 4, centerY - 3, 2.5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(centerX + 4, centerY - 3, 2.5, 0, Math.PI * 2);
                        ctx.fill();

                        // èƒ½é‡è±†å€’æ•¸æç¤ºï¼ˆæœ€å¾Œ5ç§’ï¼‰
                        if (isWarning) {
                            ctx.fillStyle = '#FF0000';
                            ctx.font = 'bold 10px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(Math.ceil(timeRemaining), centerX, centerY + powerRadius + 15);
                        }
                    } else {
                        // æ™®é€šæ¨¡å¼æˆ–é–ƒçˆæ™‚é¡¯ç¤ºæ™®é€šå¤–è§€
                        const normalRadius = CELL_SIZE / 2 - 2;

                        ctx.fillStyle = player.color;
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, normalRadius, 0, Math.PI * 2);
                        ctx.fill();

                        // çœ¼ç›
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.arc(centerX - 3, centerY - 2, 2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(centerX + 3, centerY - 2, 2, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // åå­—ï¼ˆå§‹çµ‚é¡¯ç¤ºï¼‰
                    ctx.fillStyle = player.color;
                    ctx.font = 'bold 9px Arial';
                    ctx.textAlign = 'center';
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.strokeText(player.name, centerX, player.y * CELL_SIZE - 5);
                    ctx.fillText(player.name, centerX, player.y * CELL_SIZE - 5);
                });
            }

            // ç¹ªè£½è¨ˆæ™‚å™¨ï¼ˆé ‚éƒ¨ä¸­å¤®ï¼‰
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            const timeText = `â±ï¸ ${minutes}:${seconds.toString().padStart(2, '0')}`;

            ctx.save();
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';

            // æœ€å¾Œ30ç§’ç´…è‰²é–ƒçˆ
            if (isLastThirty) {
                const flashIntensity = Math.floor(now / 250) % 2 === 0 ? 1.0 : 0.6;
                ctx.fillStyle = `rgba(255, 0, 0, ${flashIntensity})`;
                ctx.strokeStyle = '#FFF';
            } else {
                ctx.fillStyle = '#FFF';
                ctx.strokeStyle = '#000';
            }

            ctx.lineWidth = 4;
            ctx.strokeText(timeText, canvas.width / 2, 40);
            ctx.fillText(timeText, canvas.width / 2, 40);
            ctx.restore();

            // æœ€å¾Œ30ç§’è­¦å‘Šæ–‡å­—
            if (isLastThirty) {
                ctx.save();
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#FF0000';
                ctx.strokeStyle = '#FFF';
                ctx.lineWidth = 3;
                const warningText = 'âš ï¸ æœ€å¾Œ 30 ç§’ï¼âš ï¸';
                ctx.strokeText(warningText, canvas.width / 2, 70);
                ctx.fillText(warningText, canvas.width / 2, 70);
                ctx.restore();
            }

            // ç¹ªè£½åˆ†æ•¸é£„å­—å‹•ç•«
            floatingTexts = floatingTexts.filter(ft => {
                const elapsed = now - ft.createdAt;
                if (elapsed > 1500) return false; // 1.5ç§’å¾Œç§»é™¤

                // è¨ˆç®—å‹•ç•«åƒæ•¸
                ft.y -= 0.5; // å‘ä¸Šé£„
                ft.alpha = Math.max(0, 1 - elapsed / 1500); // æ·¡å‡º

                // ç¹ªè£½
                ctx.save();
                ctx.globalAlpha = ft.alpha;
                ctx.fillStyle = ft.color;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.strokeText(ft.text, ft.x, ft.y);
                ctx.fillText(ft.text, ft.x, ft.y);
                ctx.restore();

                return true; // ä¿ç•™
            });

            requestAnimationFrame(gameLoop);
        }
        
        // é¡¯ç¤ºéŠæˆ²çµç®—ç•«é¢
        function showGameResults() {
            if (!gameState || !gameState.players) return;

            // ä¿å­˜ç©å®¶æ•¸æ“šå¾Œåœæ­¢éŠæˆ²å¾ªç’°
            const finalPlayers = gameState.players;
            gameState = null;

            // è¨ˆç®—æ’å
            const rankings = Object.entries(finalPlayers || {})
                .map(([id, player]) => ({
                    id,
                    name: player.name,
                    color: player.color,
                    score: player.score || 0
                }))
                .sort((a, b) => b.score - a.score);

            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç¹ªè£½æ¨™é¡Œ
            ctx.save();
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#FFD700';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 5;
            ctx.strokeText('ğŸ† éŠæˆ²çµæŸ ğŸ†', canvas.width / 2, 80);
            ctx.fillText('ğŸ† éŠæˆ²çµæŸ ğŸ†', canvas.width / 2, 80);
            ctx.restore();

            // ç¹ªè£½æ’å
            let startY = 150;
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

            rankings.forEach((player, index) => {
                const isMe = player.id === currentPlayerId;
                const y = startY + index * 60;

                // èƒŒæ™¯ï¼ˆè‡ªå·±çš„æ’åé«˜äº®ï¼‰
                if (isMe) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.2)';
                    ctx.fillRect(canvas.width / 2 - 300, y - 35, 600, 55);
                }

                // æ’åæ•¸å­—æˆ–çç‰Œ
                ctx.save();
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'right';
                ctx.fillStyle = '#FFF';

                const rankText = index < 3 ? medals[index] : `#${index + 1}`;
                ctx.fillText(rankText, canvas.width / 2 - 200, y);

                // ç©å®¶é¡è‰²é»
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(canvas.width / 2 - 160, y - 10, 15, 0, Math.PI * 2);
                ctx.fill();

                // ç©å®¶åå­—
                ctx.font = 'bold 28px Arial';
                ctx.textAlign = 'left';
                ctx.fillStyle = '#FFF';
                const nameText = `${player.name}${isMe ? ' (ä½ )' : ''}`;
                ctx.fillText(nameText, canvas.width / 2 - 130, y);

                // åˆ†æ•¸
                ctx.textAlign = 'right';
                ctx.fillStyle = '#FFD700';
                ctx.fillText(`${player.score} åˆ†`, canvas.width / 2 + 250, y);

                ctx.restore();
            });

            // ç¹ªè£½æç¤ºæ–‡å­—
            ctx.save();
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillStyle = '#AAA';
            ctx.fillText('15ç§’å¾Œè‡ªå‹•è¿”å›å¤§å»³ï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•', canvas.width / 2, canvas.height - 50);
            ctx.restore();

            // 15ç§’å¾Œè‡ªå‹•è¿”å›å¤§å»³
            setTimeout(() => {
                window.location.reload();
            }, 15000);
        }

        // é›¢é–‹æˆ¿é–“
        async function leaveRoom() {
            if (currentRoomId && currentPlayerId && database) {
                const playerRef = database.ref(`rooms/${currentRoomId}/players/${currentPlayerId}`);
                await playerRef.remove();
            }
            window.location.reload();
        }
        
        // é é¢è¼‰å…¥å¾Œè¨­å®šäº‹ä»¶ç›£è½å™¨
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners');
            
            const btnShowCreate = document.getElementById('btnShowCreate');
            const btnShowJoin = document.getElementById('btnShowJoin');
            const btnCreateRoom = document.getElementById('btnCreateRoom');
            const btnJoinRoom = document.getElementById('btnJoinRoom');
            
            console.log('Button elements:', {
                btnShowCreate: btnShowCreate ? 'Found' : 'Not found',
                btnShowJoin: btnShowJoin ? 'Found' : 'Not found',
                btnCreateRoom: btnCreateRoom ? 'Found' : 'Not found',
                btnJoinRoom: btnJoinRoom ? 'Found' : 'Not found'
            });
            
            btnShowCreate.addEventListener('click', function() {
                console.log('btnShowCreate clicked');
                showCreateRoom();
            });
            btnShowJoin.addEventListener('click', function() {
                console.log('btnShowJoin clicked');
                showJoinRoom();
            });
            btnCreateRoom.addEventListener('click', function() {
                console.log('btnCreateRoom clicked');
                createRoom();
            });
            btnJoinRoom.addEventListener('click', function() {
                console.log('btnJoinRoom clicked');
                joinRoom();
            });
            document.getElementById('btnBackFromCreate').addEventListener('click', backToMenu);
            document.getElementById('btnBackFromJoin').addEventListener('click', backToMenu);
            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('btnLeaveLobby').addEventListener('click', leaveRoom);
            document.getElementById('btnLeaveGame').addEventListener('click', leaveRoom);
            
            // Enter éµæ”¯æŒ
            document.getElementById('hostName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createRoom();
            });
            document.getElementById('playerName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom();
            });
            document.getElementById('roomCode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') joinRoom();
            });
            
            console.log('Event listeners set up successfully');
        });
    </script>
</body>
</html>